---
title: '"Convert Numeric Vectors to Coded Factors"'
author: "Chenoa Schatzki-McClain"
date: "April 4, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r clear environment}

rm(list=ls())

```

```{r load libraries}
library(stringr)
```

```{r load files}

# Load IFLS4 << numeric vectors
IFLS4 <- read.csv("C:/Users/cheno/Desktop/IFLS_all/DATA/R datasets/IFLS4.csv")

# Load IFLS5 << labeled factors
IFLS5 <- read.csv("C:/Users/cheno/Desktop/IFLS_all/DATA/R datasets/IFLS5.csv")

#relabel "respndnt" as "rspndnt" in IFLS4 to match IFLS5 and codebooks
names(IFLS4)[names(IFLS4) == "respndnt"] <- "rspndnt"

```

```{r recode ed}
#recode highest education levels (DL06)

#IFLS4
IFLS4$dl06 <- paste0(IFLS4$dl06)

IFLS4$dl_test

#check that no new NAs were introduced
for (i in 1:length(IFLS4$dl06)){
IFLS4$dl_test[i] <-
              if(IFLS4$dl06[i] %in% c("2","11","72")) {"elementary"
                  } else if (IFLS4$dl06[i] %in% c("3", "4", "12", "73")) {"juniorH"
                  } else if (IFLS4$dl06[i] %in% c("5", "6", "15", "74", "14")) {"seniorH"
                  } else if (IFLS4$dl06[i] %in% c("60", "61", "62", "63", "13")) {"higher"
                  } else if (IFLS4$dl06[i] %in% c("17", "95", "99")) {NA
                  } else {NA
                  }
}
     

#IFLS5 >>> edit so that string extract works

for (i in 1:length(IFLS5$dl06)){
IFLS5$dl_test[i] <-  if(str_extract(IFLS5$dl06[i], "^[\\d]+(?=:)") %in% c("2","11","72")) {"elementary"
                  } else if (str_extract(IFLS5$dl06[i], "^[\\d]+(?=:)") %in% c("3", "4", "12", "73")) {"juniorH"
                  } else if (str_extract(IFLS5$dl06[i], "^[\\d]+(?=:)") %in% c("5", "6", "15", "74", "14")) {"seniorH"
                  } else if (str_extract(IFLS5$dl06[i], "^[\\d]+(?=:)") %in% c("60", "61", "62", "63", "13")) {"higher"
                  } else if (str_extract(IFLS5$dl06[i], "^[\\d]+(?=:)") %in% c("17", "95", "98", "99")) {"*"
                  } else {"**"}
}
         
```




```{r list factor vars}

#list of vars for which type == class in IFLS5
vars <- names(IFLS5)[sapply(IFLS5[,names(IFLS5)], class) == "factor"]

```

```{r releveling function}

relevel_IFLS5 <- function(var){

  lev <- levels(IFLS5[,var])
  num <- as.numeric(str_extract(levels(IFLS5[,var]), "^[\\d]+(?=:)"))
  num <- sort(num)
  lev2 <- vector(length = length(lev))
  for (i in 1:length(lev)){
    lev2[i] <- lev[as.numeric(str_extract(levels(IFLS5[,var]), "^[\\d]+(?=:)")) == num[i]]
  }
  return(lev2)
  
}

```

```{r apply releveling function}

for (i in 1:length(vars)){
levels(IFLS5[,vars[i]]) <-  relevel_IFLS5(vars[i])
}

```

```{r function to convert IFLS4 vectors to labeled factors}

convert <- function(var){
  temp <- as.factor(IFLS4[,var])
  
  #check that all levels are present and the same in both datasets >> could still be issues if coding is inconsistent
  if(length(levels(temp)) == length(levels(IFLS5[,var]))){
    if(sum(levels(temp) == str_extract(levels(IFLS5[,var]), "^[\\d]+(?=:)"))== length(levels(temp))){
  levels(temp) <- levels(IFLS5[,var])}}
  return(temp)
}

```

```{r convert factors}


for (i in 1:length(vars)){
  IFLS4[,vars[i]] <- convert(vars[i])
}

level_missing <- c()
```

```{r check conversion}

#develop a list of vars in which levels don't match across survey years
for (i in 1:length(vars)){
  if(length(levels(IFLS4[,vars[i]])) != length(levels(IFLS5[,vars[i]]))){
    level_missing <- c(level_missing,vars[i])
  }
  else if(sum(levels(IFLS4[,vars[i]]) == levels(IFLS5[,vars[i]])) != length(levels(IFLS4[,vars[i]]))){
    level_missing <- c(level_missing,paste0(vars[i], "**"))
  }
}
 
```

