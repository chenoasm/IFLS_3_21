---
title: '"Convert Numeric Vectors to Coded Factors"'
author: "Chenoa Schatzki-McClain"
date: "April 4, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)paste0(IFLS5$dl06[20])
```

```{r clear environment}

rm(list=ls())

```

```{r load libraries}
library(stringr)
```

```{r load files}

# Load IFLS4 << numeric vectors
IFLS4 <- read.csv("C:/Users/cheno/Desktop/IFLS_all/DATA/R datasets/IFLS4.csv")

# Load IFLS5 << labeled factors
IFLS5 <- read.csv("C:/Users/cheno/Desktop/IFLS_all/DATA/R datasets/IFLS5.csv")

#relabel "respndnt" as "rspndnt" in IFLS4 to match IFLS5 and codebooks
names(IFLS4)[names(IFLS4) == "respndnt"] <- "rspndnt"

```

```{r recode ed}
#recode highest education levels (DL06)

#IFLS4
IFLS4$dl06 <- paste0(IFLS4$dl06)

#check that no new NAs were introduced
for (i in 1:length(IFLS4$dl06)){
IFLS4$dl06_b[i] <-
              if(IFLS4$dl06[i] %in% c("2","11","72")) {1
                  } else if (IFLS4$dl06[i] %in% c("3", "4", "12", "73")) {2
                  } else if (IFLS4$dl06[i] %in% c("5", "6", "15", "74", "14")) {3
                  } else if (IFLS4$dl06[i] %in% c("60", "61", "62", "63", "13")) {4
                  } else if (IFLS4$dl06[i] %in% c("17", "95", "99")) {NA
                  } else {NA
                  }
}
     

#IFLS5 >>> NOTE: KINDERGARTEN CATEGROIZED AS ELEMENTARY

for (i in 1:length(IFLS5$dl06)){
IFLS5$dl06_b[i] <-  if(str_extract(as.character(IFLS5$dl06[i]), "^[\\d]+(?=:)") %in% c("2","11","72", "90")) {"1:elementary"
                  } else if (str_extract(as.character(IFLS5$dl06[i]), "^[\\d]+(?=:)") %in% c("3", "4", "12", "73")) {"2:juniorH"
                  } else if (str_extract(as.character(IFLS5$dl06[i]), "^[\\d]+(?=:)") %in% c("5", "6", "15", "74", "14")) {"3:seniorH"
                  } else if (str_extract(as.character(IFLS5$dl06[i]), "^[\\d]+(?=:)") %in% c("60", "61", "62", "63", "13")) {"4:higher"
                  } else if (str_extract(as.character(IFLS5$dl06[i]), "^[\\d]+(?=:)") %in% c("17", "95", "98", "99")) {NA
                  } else {NA}
}

IFLS4$dl06 <- IFLS4$dl06_b
IFLS5$dl06 <- as.factor(IFLS5$dl06_b)

IFLS4$dl06_b <- NULL
IFLS5$dl06_b <- NULL
```

```{r repeat ed recode for husband}


#IFLS4
IFLS4$dl06_H <- paste0(IFLS4$dl06_H)

#check that no new NAs were introduced
for (i in 1:length(IFLS4$dl06_H)){
IFLS4$dl06_H_b[i] <-
              if(IFLS4$dl06_H[i] %in% c("2","11","72")) {1
                  } else if (IFLS4$dl06_H[i] %in% c("3", "4", "12", "73")) {2
                  } else if (IFLS4$dl06_H[i] %in% c("5", "6", "15", "74", "14")) {3
                  } else if (IFLS4$dl06_H[i] %in% c("60", "61", "62", "63", "13")) {4
                  } else if (IFLS4$dl06_H[i] %in% c("17", "95", "99")) {NA
                  } else {NA
                  }
}
     

#IFLS5 >>> NOTE: KINDERGARTEN CATEGROIZED AS ELEMENTARY

for (i in 1:length(IFLS5$dl06_H)){
IFLS5$dl06_H_b[i] <-  if(str_extract(as.character(IFLS5$dl06_H[i]), "^[\\d]+(?=:)") %in% c("2","11","72", "90")) {"1:elementary"
                  } else if (str_extract(as.character(IFLS5$dl06_H[i]), "^[\\d]+(?=:)") %in% c("3", "4", "12", "73")) {"2:juniorH"
                  } else if (str_extract(as.character(IFLS5$dl06_H[i]), "^[\\d]+(?=:)") %in% c("5", "6", "15", "74", "14")) {"3:seniorH"
                  } else if (str_extract(as.character(IFLS5$dl06_H[i]), "^[\\d]+(?=:)") %in% c("60", "61", "62", "63", "13")) {"4:higher"
                  } else if (str_extract(as.character(IFLS5$dl06_H[i]), "^[\\d]+(?=:)") %in% c("17", "95", "98", "99")) {NA
                  } else {NA}
}

IFLS4$dl06_H <- IFLS4$dl06_H_b
IFLS5$dl06_H <- as.factor(IFLS5$dl06_H_b)

IFLS4$dl06_H_b <- NULL
IFLS5$dl06_H_b <- NULL

```

```{r list factor vars}

#list of vars for which type == factor in IFLS5
vars <- names(IFLS5)[sapply(IFLS5[,names(IFLS5)], class) == "factor"]

```

```{r releveling function}

relevel_IFLS5 <- function(var){

  lev <- levels(IFLS5[,var])
  num <- as.numeric(str_extract(levels(IFLS5[,var]), "^[\\d]+(?=:)"))
  num <- sort(num)
  lev2 <- vector(length = length(lev))
  for (i in 1:length(lev)){
    lev2[i] <- lev[as.numeric(str_extract(levels(IFLS5[,var]), "^[\\d]+(?=:)")) == num[i]]
  }
  return(lev2)
  
}

```

```{r apply releveling function}

for (i in 1:length(vars)){
levels(IFLS5[,vars[i]]) <-  relevel_IFLS5(vars[i])
}

```

```{r function to convert IFLS4 vectors to labeled factors}

convert <- function(var){
  temp <- as.factor(IFLS4[,var])
  
  #check that all levels are present and the same in both datasets >> could still be issues if coding is inconsistent
  if(length(levels(temp)) == length(levels(IFLS5[,var]))){
    if(sum(levels(temp) == str_extract(levels(IFLS5[,var]), "^[\\d]+(?=:)"))== length(levels(temp))){
  levels(temp) <- levels(IFLS5[,var])}}
  return(temp)
}

```

```{r convert factors}


for (i in 1:length(vars)){
  IFLS4[,vars[i]] <- convert(vars[i])
}

level_missing <- c()
```

```{r check conversion}

#develop a list of vars in which levels don't match across survey years
for (i in 1:length(vars)){
  if(length(levels(IFLS4[,vars[i]])) != length(levels(IFLS5[,vars[i]]))){
    level_missing <- c(level_missing,vars[i])
  }
  else if(sum(levels(IFLS4[,vars[i]]) == levels(IFLS5[,vars[i]])) != length(levels(IFLS4[,vars[i]]))){
    level_missing <- c(level_missing,paste0(vars[i], "**"))
  }
}
 
```


```{r combine surveys}

#relabel vars
names(IFLS4)[c(2,3,4,40,66)] <- c("pid", "hhid", "hhid_9", "hhid_9.y", "sc_code")
names(IFLS5)[c(2,3,4,40,66)] <- c("pid", "hhid", "hhid_9", "hhid_9.y", "sc_code")

#bind
IFLS_4_5 <- bind_rows(IFLS4, IFLS5)

```
